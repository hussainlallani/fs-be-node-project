name: Deploy Node.js App to Contabo
on: push

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      # Step 1: Checkout code
      - uses: actions/checkout@v4

      # Step 2: Copy files to VPS via SCP
      - name: Copy files via SCP
        uses: appleboy/scp-action@master
        with:
          host: ${{ secrets.SSH_HOST }}
          username: root
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          source: "./"
          target: "/var/www/fs-be-node-project"
          port: 22
          overwrite: true
          strip_components: 1
          debug: true

      # Step 3: SSH into VPS to set up and run the Node.js app
      - name: Install Node.js and run app
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.SSH_HOST }}
          username: root
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          port: 22
          script: |
            # Navigate to the project directory
            cd /var/www/fs-be-node-project

            # Install Node.js (if not already installed)
            if ! command -v node &> /dev/null; then
              curl -fsSL https://deb.nodesource.com/setup_20.x | sudo -E bash -
              sudo apt-get install -y nodejs
            fi

            # Install dependencies
            npm install

            # Kill any existing Node process running on port 3000
            sudo pkill -f "node app.js" || true

            # Start the app in the background (with PM2 for process management)
            if ! command -v pm2 &> /dev/null; then
              npm install -g pm2
            fi
            pm2 start app.js --name "fs-be-node-app"

            # Ensure PM2 starts on reboot
            pm2 startup
            pm2 save
