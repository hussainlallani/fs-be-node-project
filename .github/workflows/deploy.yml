name: Deploy Node.js App to Contabo
on: push

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Copy files via SCP
        uses: appleboy/scp-action@master
        with:
          host: ${{ secrets.SSH_HOST }}
          username: root
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          source: "."
          target: "/var/www/fs-be-node-project"
          port: 22
          overwrite: true
          # Removed strip_components as it was removing package.json
          debug: true

      - name: Setup Node.js and run app
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.SSH_HOST }}
          username: root
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          script: |
            # Navigate to project directory
            cd /var/www/fs-be-node-project

            # Verify files were copied
            ls -la

            # Install Node.js (if needed)
            if ! command -v node &> /dev/null; then
              curl -fsSL https://deb.nodesource.com/setup_20.x | sudo -E bash -
              sudo apt-get install -y nodejs
            fi

            # Install dependencies only if package.json exists
            if [ -f "package.json" ]; then
              npm install --production
              
              # Stop existing PM2 process if running
              pm2 delete fs-be-node-app 2> /dev/null || true
              
              # Start with PM2
              npm install -g pm2
              pm2 start server.js --name "fs-be-node-app"
              pm2 save
              pm2 startup
            else
              echo "ERROR: package.json not found!"
              exit 1
            fi
