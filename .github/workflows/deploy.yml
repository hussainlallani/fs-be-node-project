name: Deploy Node.js App to Contabo

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest
    environment: production
    env:
      IGDB_CLIENT_ID: ${{ vars.IGDB_CLIENT_ID }}
      IGDB_ACCESS_TOKEN: ${{ vars.IGDB_ACCESS_TOKEN }}
    steps:
      - name: Checkout Repo
        uses: actions/checkout@v4

      - name: Copy Files via SCP
        uses: appleboy/scp-action@master
        with:
          host: ${{ secrets.SSH_HOST }}
          username: root
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          port: 22
          source: "."
          target: "/var/www/fs-be-node-project"
          overwrite: true
          strip_components: 1

      - name: Setup & Run Node.js + Next.js Apps
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.SSH_HOST }}
          username: root
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          port: 22
          script: |
            echo "ðŸ”§ Starting deploy on $(hostname)"
            cd /var/www/fs-be-node-project || {
              echo "âŒ Failed to find project directory!"
              exit 1
            }

            echo "ðŸ“ Project directory contents:"
            ls -la

            # Node.js Setup
            if ! command -v node &> /dev/null; then
              echo "ðŸ“¥ Installing Node.js..."
              curl -fsSL https://deb.nodesource.com/setup_20.x | sudo -E bash -
              sudo apt-get install -y nodejs
            fi

            # PM2 Setup
            if ! command -v pm2 &> /dev/null; then
              echo "ðŸ“¥ Installing PM2..."
              npm install -g pm2
            fi

            # Backend Setup
            echo "ðŸ§¹ Cleaning backend build..."
            npm run clean || true
            echo "ðŸ“¦ Installing backend dependencies..."
            npm ci --production
            echo "ðŸ—ï¸ Building backend..."
            npm run build

            # MongoDB
            pm2 delete mongo_fs_be_node_project 2>/dev/null || true
            pm2 start "mongod --config /etc/mongod.conf" --name "mongo_fs_be_node_project"

            # Node.js App
            pm2 delete fs-be-node-app 2>/dev/null || true
            pm2 start dist/index.js --name "fs-be-node-app"

            # GameHub Next.js Setup
            echo "ðŸš€ Deploying GameHub Next.js app..."
            cd gamehub || {
              echo "âŒ GameHub directory not found!"
              exit 1
            }

            echo "ðŸ“¦ Installing GameHub dependencies..."
            npm install

            echo "ðŸ—ï¸ Building GameHub..."
            npm run build

            pm2 delete gamehub-next-app 2>/dev/null || true
            pm2 start "npm run start" --name "gamehub-next-app" --cwd /var/www/fs-be-node-project/gamehub

            # Save PM2 state
            pm2 save
            pm2 startup systemd -u root --hp /root

            echo "ðŸŽ‰ Deployment completed successfully!"
