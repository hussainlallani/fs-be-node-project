name: Deploy Node.js App to Contabo

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Repo
        uses: actions/checkout@v4

      - name: Copy Files via SCP
        uses: appleboy/scp-action@master
        with:
          host: ${{ secrets.SSH_HOST }}
          username: root
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          port: 22
          source: "."
          target: "/var/www/fs-be-node-project"
          overwrite: true
          strip_components: 1 # Prevents creating an extra directory level

      - name: Setup & Run Node.js App
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.SSH_HOST }}
          username: root
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          port: 22
          script: |
            echo "ğŸ”§ Starting deploy on $(hostname)"

            # Navigate to project directory
            cd /var/www/fs-be-node-project || {
              echo "âŒ Failed to find project directory!"
              exit 1
            }

            echo "ğŸ“ Project directory contents:"
            ls -la

            # Install Node.js (if needed)
            if ! command -v node &> /dev/null; then
              echo "ğŸ“¥ Installing Node.js..."
              curl -fsSL https://deb.nodesource.com/setup_20.x | sudo -E bash -
              sudo apt-get install -y nodejs
            else
              echo "âœ… Node.js $(node -v) already installed"
            fi

            # Install PM2 globally (if needed)
            if ! command -v pm2 &> /dev/null; then
              echo "ğŸ“¥ Installing PM2..."
              npm install -g pm2
            else
              echo "âœ… PM2 $(pm2 -v) already installed"
            fi

            # Clean previous builds
            echo "ğŸ§¹ Cleaning previous build..."
            npm run clean

            # Install dependencies
            echo "ğŸ“¦ Installing dependencies..."
            npm ci --production
            npm install -g typescript 

            # Run build
            echo "ğŸ—ï¸ Building application..."
            npm run build

            # Stop existing PM2 process if running
            echo "ğŸ›‘ Stopping existing PM2 process..."
            pm2 delete fs-be-node-app 2>/dev/null || true

            # Start application with PM2
            echo "ğŸš€ Starting application..."
            pm2 start dist/index.js --name "fs-be-node-app" || {
              echo "âŒ Failed to start application"
              exit 1
            }

            # Save PM2 process list
            echo "ğŸ’¾ Saving PM2 process list..."
            pm2 save

            # Configure PM2 startup
            echo "ğŸ” Setting up PM2 startup..."
            pm2 startup systemd -u root --hp /root
            pm2 save

            echo "ğŸ‰ Deployment completed successfully!"
