name: Deploy Node.js App to Contabo

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Repo
        uses: actions/checkout@v4

      - name: Copy Files via SCP
        uses: appleboy/scp-action@master
        with:
          host: ${{ secrets.SSH_HOST }}
          username: root
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          port: 22
          source: "."
          target: "/var/www/fs-be-node-project"
          overwrite: true
          strip_components: 1

      - name: Setup & Run Node.js + Next.js Apps
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.SSH_HOST }}
          username: root
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          port: 22
          envs: IGDB_CLIENT_ID,IGDB_ACCESS_TOKEN
          script: |
            echo "üîß Starting deploy on $(hostname)"
            cd /var/www/fs-be-node-project || {
              echo "‚ùå Failed to find project directory!"
              exit 1
            }

            echo "üå± Writing .env file..."
            cat <<EOF > .env
            IGDB_CLIENT_ID=$IGDB_CLIENT_ID
            IGDB_ACCESS_TOKEN=$IGDB_ACCESS_TOKEN
            EOF

            echo "üìÅ Project directory contents:"
            ls -la

            # Node.js Setup
            if ! command -v node &> /dev/null; then
              echo "üì• Installing Node.js..."
              curl -fsSL https://deb.nodesource.com/setup_20.x | sudo -E bash -
              sudo apt-get install -y nodejs
            fi

            # PM2 Setup
            if ! command -v pm2 &> /dev/null; then
              echo "üì• Installing PM2..."
              npm install -g pm2
            fi

            # Backend Setup
            echo "üßπ Cleaning backend build..."
            npm run clean || true
            echo "üì¶ Installing backend dependencies..."
            npm ci --production
            echo "üèóÔ∏è Building backend..."
            npm run build

            # MongoDB
            pm2 delete mongo_fs_be_node_project 2>/dev/null || true
            pm2 start "mongod --config /etc/mongod.conf" --name "mongo_fs_be_node_project"

            # Node.js App
            pm2 delete fs-be-node-app 2>/dev/null || true
            pm2 start dist/index.js --name "fs-be-node-app"

            # GameHub Next.js Setup
            echo "üöÄ Deploying GameHub Next.js app..."
            cd gamehub || {
              echo "‚ùå GameHub directory not found!"
              exit 1
            }

            echo "üì¶ Installing GameHub dependencies..."
            npm install

            echo "üèóÔ∏è Building GameHub..."
            npm run build

            pm2 delete gamehub-next-app 2>/dev/null || true
            pm2 start "npm run start" --name "gamehub-next-app" --cwd /var/www/fs-be-node-project/gamehub

            # Save PM2 state
            pm2 save
            pm2 startup systemd -u root --hp /root

            echo "üéâ Deployment completed successfully!"
